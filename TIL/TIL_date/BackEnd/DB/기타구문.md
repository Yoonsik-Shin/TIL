# 기타 구문 정리

​    

## 1️⃣ CASE문

- 특정 상황에서 데이터를 변환하여 활용
- ELSE 생략 시 NULL값 지정

```sql
CASE
	WHEN 조건식 THEN 식
	WHEN 조건식 THEN 식
	ELSE 식
END
```

```sql
# 예시
SELECT
	last_name,
	age,
	CASE
		WHEN age < 18 THEN '청소년'
		WHEN age <= 30 THEN '청년'
		WHEN age <= 64 THEN '중장년'
	END
FROM users
LIMIT 15;
```

​    

## 2️⃣ 서브쿼리

- 특정한 값을 메인 쿼리에 반환하여 활용

- 실제 테이블에 없는 기준을 이용한 검색 가능

- __소괄호__로 감싸서 활용

- 메인 쿼리의 컬럼 모두 사용가능 / ❗메인 쿼리는 서브 쿼리의 컬럼 사용 불가

```sql
SELECT *
FROM <테이블명>
WHERE <컬럼1> = (
		SELECT <컬럼1>
		FROM <테이블명>
);
```

​    

### 1. 단일행 서브쿼리

- 서브쿼리의 결과가 0 or 1 개인 경우
- 주로 단일행 비교 연산자와 함께 사용 (`=, <, >, <>`)

1. WHERE절에서의 활용

```sql
-- 예시 : 가장 나이가 적은 사람의 수
SELECT count(*)
FROM <테이블명>
WHERE age = (SELECT MIN(age) FROM <테이블명>);
```

​    

2. SELECT절에서의 활용

```sql
-- 예시 : 전체 인원과 평균 연봉, 평균 나이
SELECT
		(SELECT count(*) FROM users) AS 총인원,
		(SELECT AVG(balance) FROM users) AS 평균연봉,
		(SELECT AVG(age) FROM users) AS 평균나이
;
```

​    

3. UPDATE에서 활용

```sql
-- 예시 : users 테이블의 모든 잔고값을 평균 잔고값으로 바꾸기 
UPDATE users
SET balance = (SELECT AVG(balance) FROM users);
```

​    

### 2. 다중행 서브쿼리

- 서브쿼리 결과가 2개 이상인 경우
- 주로 다중행 비교 연산자와 함께 사용 (`IN, EXISTS`)

```sql
-- 예시 : a라는 이름을 갖는 사람과 같은 지역에 사는 사람의 수
SELECT count(*)
FROM users
WHERE country IN(
		SELECT country
		FROM users
		WHERE name = 'a'
);
```

​    

### 3. 다중컬럼 서브쿼리

```sql
-- 예시 : 특정 성씨에서 가장 어린 사람들의 이름과 나이
SELECT
	last_name,
	first_name,
	age
FROM users
WHERE (last_name, age) IN(
	SELECT last_name, Min(age)
	FROM users
	GROUP BY last_name)
ORDER BY last_name;
```

​    

## 3️⃣ 날짜 / 시간 다루기

- 현재 날짜 / 시간

```sql
SELECT NOW()
>> 2023-02-23 00:00:00
```

- 날짜 / 시간 형식 변환

```sql
 SELECT DATE_FORMAT(NOW(), "%Y-%m")
 >> 2023-02
 
 SELECT DATE_FORMAT(NOW(), "%Y")
 >> 2023
```

> format 종류

| 구분자 | 설명               |
| ------ | ------------------ |
| %d     | 00 ~ 31일          |
| %e     | 0 ~ 31일           |
| %H     | 00 ~ 23시          |
| %k     | 0 ~ 23시           |
| %h     | 01 ~ 12시          |
| %l     | 1 ~ 12시           |
| %M     | January ~ December |
| %m     | 00 ~ 12월          |
| %U     | 00 ~ 53주 (일)     |
| %u     | 00 ~ 53주 (월)     |
| %Y     | 4자리 연도         |
| %y     | 2자리 연도         |



- 날짜 더하기 빼기

```sql
SELECT DATE_ADD('2022-02-23', INTERVAL 1 DAY); -- 날짜에 하루를 더합니다.
>> 2022-02-24

SELECT DATE_SUB('2022-02-23', INTERVAL 1 WEEK); -- 날짜에서 일주일을 뺍니다.
>> 2022-02-16
```

- 날짜 차이 계산하기

> ❗주의점 : 1일 차이 주의

```sql
SELECT DATEDIFF('2022-02-28', '2022-02-23'); -- 두 날짜 간의 차이(일)를 계산합니다.
>> 5
```

- 날짜 비교

```sql
-- order_date가 2022-02-23 이후인 주문 정보를 조회합니다.
SELECT * FROM orders WHERE order_date > '2022-02-23'; 
```

- 날짜 추출하기

```sql
SELECT YEAR('2022-02-23'); -- 날짜에서 연도를 추출합니다.
SELECT MONTH('2022-02-23'); -- 날짜에서 월을 추출합니다.
SELECT DAY('2022-02-23'); -- 날짜에서 일을 추출합니다.
```

- 연월 단위로 그룹핑

```sql
SELECT 
		DATE_FORMAT(order_date, '%Y-%m') AS order_month, 
		COUNT(*) AS orders_count
FROM 
		orders
GROUP BY
		order_month;
```

​    

## 4️⃣ 실습 개념 추가정리

```sqlite
-- 모든 테이블 이름 조회
sqlite> .tables

-- 모든 테이블의 데이터 확인
sqlite> .schema
```

```sql
-- Alias 설정시 주의사항
한글 띄어쓰기 사용시 작은 따옴표 대신 `큰 따옴표 ("")` 사용해야함
```

```sql
-- strftime 함수 > 문자열로 반환
strftime('형식', 컬럼) 

-- 예시
strftime('%Y', 컬럼명)
>> '2013'
```

```sql
-- cast 함수 : 형식변환
cast(바꿀값 as int) 
```



